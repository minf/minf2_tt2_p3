<html>
  <head>
    <title>Reinforcement Blackjack</title>

    <script type="text/javascript" src="jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="tooltip.js"></script>
    <script type="text/javascript" src="cardstack.js"></script>
    <script type="text/javascript" src="blackjack.js"></script>
    <script type="text/javascript" src="player.js"></script>
    <script type="text/javascript" src="dealer.js"></script>
    <script type="text/javascript" src="game.js"></script>
    <script type="text/javascript" src="human_player.js"></script>
    <script type="text/javascript" src="montecarlo_player.js"></script>
    <script type="text/javascript" src="highcharts/highcharts.js"></script>

    <link rel="stylesheet" href="blackjack.css" />
  </head>

  <body>
    <div id="page">
      <div id="dealer" class="player">
      </div>

      <div id="stack">
        <img src="images/card-stack.png" />
      </div>

      <div id="players">
      </div>
    </div>
  </body>

  <script type="text/javascript">
    $(document).ready(
      function() {
        var game = new Game();

        game.match();

        function loadDump() {
          var dump = $("textarea").val();

          $(".monte-carlo-player")[0].player.load(dump);
        }

        $("[title]").live("mouseover", function() {
          $(this).tooltip($(this).attr("title"));
        });

        $(".player").live("mouseout", function() {
          $.hideTooltips();
        });

        $("#stack").live("mouseover", function() {
          $(this).tooltip("Der Kartenstapel hat noch " + game.getCardstack().size() + " Karten");
        });

        $("#stack").live("mouseout", function() {
          $.hideTooltips();
        });

        $(".player").live("mouseover", function() {
          $(this).css("border-color", "#fff");
        });

        $(".player").live("mouseout", function() {
          $(this).css("border-color", "#888");
        });

        var dealerHand = 0;

   			$(window).keydown(
				  function(e) {
            if(e.keyCode == 27) { // 'esc' key: hide dump
              game.unpause();

              $("textarea").hide();

              $("#chart").hide();
            }

            if(e.keyCode == 68) { // 'd' key: dump monte carlo player
              game.pause();

              var dump = $(".monte-carlo-player")[0].player.dump();

              $("textarea")
                .show()
                .css("left", 50)
                .css("top", 50)
                .css("width", $(window).width() - 100)
                .css("height", $(window).height() - 100)
                .val(dump);
            }

            if(e.keyCode == 76) { // 'l' key: load copy/pasted dump into monte carlo player
              loadDump();

              alert("loaded");
            }

            // draw chart of Q values

            function drawChart() {
              game.pause();

              $("#chart")
                .css("left", 50)
                .css("top", 50)
                .css("width", $(window).width() - 100)
                .css("height", $(window).height() - 100)
                .show();

              var dataHit = [];
              var dataStick = [];
              var chartTitle = "";

              if(dealerHand<2){
                chartTitle = "Monte Carlo ES";
                if(dealerHand==1) chartTitle +=", usableAce";

                for(var p1 = 12; p1 <= 21; p1++){
                  for(var d1 = 2; d1 <= 11; d1++){
                    var mcPlayer = $(".monte-carlo-player")[0].player;
                    var stateIndex = mcPlayer.stateIndexFor(p1, d1, dealerHand);

                    if(mcPlayer.pi[stateIndex])
                      dataHit.push([p1,d1]);
                    else
                      dataStick.push([p1,d1]);
                  }
                }
              }
              else{
                var hand = dealerHand;
                var usableAce = hand > 11;
                if(usableAce) hand -= 9;
                for(var p1 = 12; p1 <= 21; p1++) {
                  var mcPlayer = $(".monte-carlo-player")[0].player;

                  dataHit.push(mcPlayer.Q[0][mcPlayer.stateIndexFor(p1, hand, usableAce?1:0)]);
                  dataStick.push(mcPlayer.Q[1][mcPlayer.stateIndexFor(p1, hand, usableAce?1:0)]);
                }
                chartTitle = "Monte Carlo ES Strategy (Dealer: " + hand + (usableAce?", usable ace":"") + ")";
              }

              new Highcharts.Chart({
                chart: {
                  renderTo: "chart",
                  defaultSeriesType: dealerHand<2?"scatter":"line",
                  marginRight: 130,
                  marginBottom: 25
                },
                title: {
                  text: chartTitle,
                  x: -20 //center
                },
                xAxis: {
                  categories: [ "12", "13", "14", "15", "16", "17", "18", "19", "20", "21" ]
                },
                yAxis: {
                  title: {
                    text: dealerHand<2?"Dealer showing":"Q"
                  },
                  plotLines: [{
                    value: 0,
                    width: 1,
                    color: "#808080"
                  }]
                },
                series: [{
                  name: dealerHand<2?"Hit":"Q(Hit)",
                  data: dataHit
                }, {
                  name: dealerHand<2?"Stick":"Q(Stick)",
                  data: dataStick
                }],
                plotOptions: {
                  scatter: {
                    marker: {
                      radius: 10
                    }
                  }
                }
              });
            }

            if(e.keyCode == 67) // 'c'
              drawChart();

            if(e.keyCode == 38) { // 'up'
              if(dealerHand < 20){
                dealerHand++;
                drawChart();
              }
            }

            if(e.keyCode == 40) { // 'down'
              if(dealerHand > 0){
                dealerHand--;
                drawChart();
              }
            }
          }
        );

        loadDump();
      }
    );
  </script>

  <textarea>
{"pi":[false,true,false,true,false,true,false,true,false,true,true,true,true,true,true,true,true,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,false,true,false,true,false,true,false,true,false,true,true,true,true,true,true,true,true,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,false,true,false,true,false,true,false,true,false,true,true,true,true,true,true,true,true,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,false,true,false,true,false,true,false,true,false,true,false,true,false,true,true,true,false,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,false,true,false,true,false,true,false,true,false,true,false,true,false,true,false,true,false,true,true,true,null,null,null,null,null,null,null,null,null,null,null,null,false,true,false,true,false,false,false,true,false,false,false,true,false,true,false,true,false,true,false,true,null,null,null,null,null,null,null,null,null,null,null,null,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,true,false,false,false,false,null,null,null,null,null,null,null,null,null,null,null,null,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,null,null,null,null,null,null,null,null,null,null,null,null,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,null,null,null,null,null,null,null,null,null,null,null,null,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false],"Q":[[-0.42326909350463954,-0.050980392156862744,-0.3341024457775727,-0.0896551724137931,-0.32620320855614976,-0.07037037037037037,-0.35014204545454547,0.11059907834101383,-0.3011968085106383,0.17054263565891473,-0.3617681271810779,-0.06472491909385113,-0.38626609442060084,-0.024822695035460994,-0.44773790951638065,-0.22377622377622378,-0.50900228350606,-0.20749542961608775,-0.591892820336654,-0.47692307692307695,null,null,null,null,null,null,null,null,null,null,null,null,-0.3908450704225352,-0.07207207207207207,-0.3983739837398374,0.03231597845601436,-0.3309608540925267,-0.02195945945945946,-0.36699321778447624,0.12224448897795591,-0.3659863945578231,0.056818181818181816,-0.4007554945054945,-0.05825242718446602,-0.4367816091954023,-0.07966101694915254,-0.48301680058436813,-0.18181818181818182,-0.5525627615062761,-0.29763387297633875,-0.6407552304813744,-0.39057239057239057,null,null,null,null,null,null,null,null,null,null,null,null,-0.46692015209125476,-0.10902255639097744,-0.44871794871794873,-0.07389937106918239,-0.47899778924097275,0.00631911532385466,-0.43243243243243246,0.029548989113530325,-0.39716840536512665,0.09119010819165378,-0.45164121467439006,-0.013493253373313344,-0.4875042793563848,-0.13914373088685014,-0.5196994685724757,-0.1661676646706587,-0.5733419050680382,-0.28309968847352024,-0.6603386351975372,-0.44242424242424244,null,null,null,null,null,null,null,null,null,null,null,null,-0.5385814497272019,-0.09970238095238096,-0.5087987758224942,-0.0728862973760933,-0.48707592891760904,-0.09025270758122744,-0.4828113063407181,0.036036036036036036,-0.48346456692913387,0.12658227848101267,-0.47883149872988995,-0.08891928864569083,-0.4966711051930759,-0.1297134238310709,-0.5547024952015355,-0.1875,-0.6133354105000779,-0.306978343073221,-0.6802005012531328,-0.37900874635568516,null,null,null,null,null,null,null,null,null,null,null,null,-0.5614320585842149,-0.0444743935309973,-0.5527522935779816,-0.18734491315136476,-0.5374697824335214,-0.06287425149700598,-0.5440613026819924,-0.038461538461538464,-0.5328836424957841,0.07934508816120907,-0.55579058699101,-0.14402173913043478,-0.5245009074410163,-0.21409574468085107,-0.6262763784887678,-0.22804718217562253,-0.6584892340275327,-0.3367379508458347,-0.7103851779619698,-0.44680851063829785,null,null,null,null,null,null,null,null,null,null,null,null,-0.6184323858742463,-0.12352168199737187,-0.6318407960199005,-0.047435897435897434,-0.6399331662489557,-0.09038737446197992,-0.6253207869974337,-0.006747638326585695,-0.6121372031662269,0.032640949554896145,-0.5880204528853178,-0.05630026809651475,-0.6027586206896551,-0.19285714285714287,-0.6364932287954383,-0.28538011695906434,-0.6840679190751445,-0.3484848484848485,-0.7473878303626306,-0.5065274151436031,null,null,null,null,null,null,null,null,null,null,null,null,-0.6842610364683301,-0.09508196721311475,-0.7122232916265641,-0.027932960893854747,-0.706581352833638,0.01485148514851485,-0.6627486437613019,0.0041841004184100415,-0.6736842105263158,0.023474178403755867,-0.6485623003194888,0.039603960396039604,-0.6351249053747161,-0.029288702928870293,-0.6858440575321726,-0.1322690992018244,-0.7452441655226515,-0.2745504840940526,-0.7571428571428571,-0.4263157894736842,null,null,null,null,null,null,null,null,null,null,null,null,-0.7972027972027972,0.0730593607305936,-0.8133732534930139,-0.06167400881057269,-0.7759295499021527,0.13025210084033614,-0.7992125984251969,0.13688212927756654,-0.7888015717092338,0.16228070175438597,-0.789431545236189,0.0851063829787234,-0.7583465818759937,-0.0379746835443038,-0.7466996699669967,-0.06639004149377593,-0.7842126957955482,-0.32413793103448274,-0.8178466076696165,-0.4074074074074074,null,null,null,null,null,null,null,null,null,null,null,null,-0.881213686249193,0.012605042016806723,-0.8904548366431775,0.012195121951219513,-0.8944300518134715,0.007326007326007326,-0.8722294654498044,0.08502024291497975,-0.8718434343434344,0.1171875,-0.8758134490238612,0,-0.8745704467353952,0,-0.8945054945054945,-0.09333333333333334,-0.8843209526509782,-0.2030612244897959,-0.8928934010152284,-0.373015873015873,null,null,null,null,null,null,null,null,null,null,null,null,-1,0.05102040816326531,-1,0.125,-1,0.044374009508716325,-1,0.14661134163208853,-1,0.1318051575931232,-1,0.06957708049113233,-1,0.026627218934911243,-1,-0.047619047619047616,-1,-0.14910394265232976,-1,-0.25370919881305637],[-0.2979937419473587,-0.2857142857142857,-0.26506024096385544,-0.2839506172839506,-0.21042298768516865,-0.23595505617977527,-0.16959471212384764,-0.04964539007092199,-0.15755395683453238,-0.30303030303030304,-0.4599375650364204,-0.31343283582089554,-0.512491559756921,-0.43661971830985913,-0.5310344827586206,-0.4146341463414634,-0.5851721094439541,-0.5891472868217055,-0.7807078417765441,-0.7974683544303798,null,null,null,null,null,null,null,null,null,null,null,null,-0.3011166025993044,-0.22007722007722008,-0.24243528982865475,-0.16083916083916083,-0.1936903888481291,-0.2129032258064516,-0.18716577540106952,-0.23333333333333334,-0.17532586744997247,-0.25301204819277107,-0.5135135135135135,-0.5085714285714286,-0.5172413793103449,-0.610738255033557,-0.5429815016322089,-0.4959349593495935,-0.5748337927679585,-0.5872,-0.7816993464052288,-0.782312925170068,null,null,null,null,null,null,null,null,null,null,null,null,-0.30477634571645185,-0.2265625,-0.24928585031422587,-0.29545454545454547,-0.21094201502600654,-0.1657142857142857,-0.15895061728395063,-0.21518987341772153,-0.1866913123844732,-0.2222222222222222,-0.5010511562718991,-0.3815789473684211,-0.5147766323024054,-0.5194805194805194,-0.5442775763852926,-0.5838926174496645,-0.5759918991070606,-0.6571428571428571,-0.7712418300653595,-0.786096256684492,null,null,null,null,null,null,null,null,null,null,null,null,-0.3079463765300175,-0.19337016574585636,-0.23965351299326276,-0.25888324873096447,-0.20657841957480946,-0.1281198003327787,-0.16541945647892872,-0.10526315789473684,-0.15569570358691368,-0.15789473684210525,-0.47465983040820353,-0.3951219512195122,-0.4935934213042647,-0.4921875,-0.5573556310425921,-0.5277777777777778,-0.5711300713912589,-0.5333333333333333,-0.7600527356624918,-0.7028571428571428,null,null,null,null,null,null,null,null,null,null,null,null,-0.2932054682717813,-0.24175824175824176,-0.25054813633645606,-0.3939393939393939,-0.20874670986029562,-0.1943127962085308,-0.1478472786352559,-0.28125,-0.1488469601677149,-0.11363636363636363,-0.47858197932053176,-0.5628415300546448,-0.5178112376055821,-0.5048543689320388,-0.5252958326187618,-0.5751295336787565,-0.566931887732797,-0.5561160151324086,-0.7850408548082967,-0.7959183673469388,null,null,null,null,null,null,null,null,null,null,null,null,-0.1421770179614802,-0.17391304347826086,-0.10339053997488488,-0.08365019011406843,-0.0779558250324816,-0.07473309608540925,-0.01883158570511449,-0.010309278350515464,0.0249033920137398,0.03498542274052478,-0.10975384045900426,-0.12813370473537605,-0.39898898718180176,-0.45539906103286387,-0.3996937212863706,-0.4039408866995074,-0.47156739666155206,-0.46795646916565903,-0.6358641358641358,-0.5862068965517241,null,null,null,null,null,null,null,null,null,null,null,null,0.11602982292637465,0.13238770685579196,0.16097122302158273,0.15796519410977242,0.18059806922533553,0.20138089758342922,0.19603916332888296,0.2048611111111111,0.2681484984629936,0.2747747747747748,0.4270597127739985,0.4043528064146621,0.09009188973232121,0.08388520971302428,-0.19566840926064227,-0.2450592885375494,-0.236128905095102,-0.21771576898118106,-0.38503217067389095,-0.3689655172413793,null,null,null,null,null,null,null,null,null,null,null,null,0.3815556118571067,0.38961038961038963,0.4176995537927615,0.4190954773869347,0.41641938674579626,0.3660130718954248,0.4499390986601705,0.49693251533742333,0.4952635414136507,0.538543897216274,0.623721881390593,0.5993723849372385,0.61324182478805,0.6045081967213115,0.26753937410513395,0.28992878942014244,-0.025503355704697986,-0.02538964303670186,-0.13757736516357205,-0.08099688473520249,null,null,null,null,null,null,null,null,null,null,null,null,0.6369104146881924,0.5989637305699482,0.6467459324155194,0.6363636363636364,0.6628068550254748,0.6397058823529411,0.6603954081632653,0.6801980198019802,0.7048561999057048,0.682570593962999,0.768646408839779,0.7874493927125507,0.7873098533643963,0.7507163323782235,0.7550963418039653,0.7259475218658892,0.43150030098084347,0.4403783918347025,0.15919369427574623,0.1683991683991684,null,null,null,null,null,null,null,null,null,null,null,null,0.8859844271412681,0.877713458755427,0.883538633818589,0.8917857142857143,0.8905191873589164,0.8789970930232558,0.9080590238365494,0.8826010544815466,0.9004602991944765,0.8995165745856354,0.9287867370007535,0.9268543956043956,0.9235831809872029,0.9214641080312722,0.9345559151384394,0.9349930843706777,0.882128533698523,0.8938249666814749,0.6475838719606033,0.6481751824817519]],"sumReturns":[[-593,-13,-724,-26,-488,-19,-493,24,-453,44,-1866,-20,-2160,-7,-2583,-64,-11591,-227,-3446,-124,null,null,null,null,null,null,null,null,null,null,null,null,-555,-32,-539,18,-465,-13,-487,61,-538,35,-2334,-36,-2584,-47,-2645,-96,-12678,-717,-3767,-232,null,null,null,null,null,null,null,null,null,null,null,null,-614,-58,-560,-47,-650,4,-576,19,-533,59,-2573,-9,-2848,-91,-2836,-111,-10702,-727,-3861,-292,null,null,null,null,null,null,null,null,null,null,null,null,-691,-67,-665,-50,-603,-25,-632,24,-614,80,-1131,-65,-1119,-86,-2023,-129,-3937,-893,-4071,-260,null,null,null,null,null,null,null,null,null,null,null,null,-690,-33,-723,-151,-667,-42,-710,-27,-632,63,-1051,-106,-867,-161,-920,-174,-3731,-1055,-4371,-315,null,null,null,null,null,null,null,null,null,null,null,null,-718,-94,-762,-37,-766,-63,-731,-5,-696,11,-805,-42,-874,-162,-893,-244,-3787,-1173,-1216,-388,null,null,null,null,null,null,null,null,null,null,null,null,-713,-29,-740,-10,-773,3,-733,1,-704,5,-812,8,-839,-7,-906,-116,-3800,-397,-1113,-243,null,null,null,null,null,null,null,null,null,null,null,null,-798,16,-815,-14,-793,31,-812,36,-803,37,-986,20,-954,-9,-905,-16,-3805,-329,-1109,-88,null,null,null,null,null,null,null,null,null,null,null,null,-1365,3,-1390,3,-1381,2,-1338,21,-1381,30,-1615,0,-1527,0,-1628,-21,-6238,-199,-1759,-94,null,null,null,null,null,null,null,null,null,null,null,null,-447,35,-465,82,-469,28,-429,106,-474,92,-688,51,-694,18,-740,-35,-2679,-416,-832,-171],[-1619,-32,-1276,-23,-1179,-21,-975,-7,-876,-20,-884,-21,-759,-31,-770,-34,-3315,-152,-1125,-63,null,null,null,null,null,null,null,null,null,null,null,null,-1645,-57,-1330,-23,-1056,-33,-1015,-70,-955,-42,-779,-89,-750,-91,-998,-122,-3545,-367,-1196,-115,null,null,null,null,null,null,null,null,null,null,null,null,-1608,-58,-1309,-52,-1095,-29,-824,-34,-1010,-40,-715,-58,-749,-80,-1051,-87,-6257,-437,-1180,-147,null,null,null,null,null,null,null,null,null,null,null,null,-1585,-35,-1245,-51,-1030,-77,-840,-24,-790,-30,-2407,-81,-2581,-126,-2133,-114,-13120,-368,-1153,-123,null,null,null,null,null,null,null,null,null,null,null,null,-1437,-44,-1257,-65,-1031,-41,-728,-54,-710,-20,-2592,-103,-2820,-104,-3063,-111,-12968,-441,-1249,-156,null,null,null,null,null,null,null,null,null,null,null,null,-657,-40,-494,-22,-360,-21,-88,-3,116,24,-593,-46,-2210,-97,-2349,-82,-10142,-387,-3819,-136,null,null,null,null,null,null,null,null,null,null,null,null,498,112,716,118,767,175,881,177,1134,244,2260,353,451,76,-1048,-62,-4792,-671,-2274,-214,null,null,null,null,null,null,null,null,null,null,null,null,1506,360,1685,417,1684,336,1847,486,2039,503,3050,573,3038,590,1308,285,-494,-101,-778,-78,null,null,null,null,null,null,null,null,null,null,null,null,4024,578,4134,588,4293,609,4142,687,4485,701,5565,778,5745,786,5408,747,12186,1769,1232,162,null,null,null,null,null,null,null,null,null,null,null,null,1593,2426,1578,2497,1578,2419,1600,2511,1565,2605,2465,2699,2526,2593,2599,2704,9018,10060,2104,1776]],"numReturns":[[1401,255,2167,290,1496,270,1408,217,1504,258,5158,309,5592,282,5769,286,22772,1094,5822,260,null,null,null,null,null,null,null,null,null,null,null,null,1420,444,1353,557,1405,592,1327,499,1470,616,5824,618,5916,590,5476,528,22944,2409,5879,594,null,null,null,null,null,null,null,null,null,null,null,null,1315,532,1248,636,1357,633,1332,643,1342,647,5697,667,5842,654,5457,668,18666,2568,5847,660,null,null,null,null,null,null,null,null,null,null,null,null,1283,672,1307,686,1238,277,1309,666,1270,632,2362,731,2253,663,3647,688,6419,2909,5985,686,null,null,null,null,null,null,null,null,null,null,null,null,1229,742,1308,806,1241,668,1305,702,1186,794,1891,736,1653,752,1469,763,5666,3133,6153,705,null,null,null,null,null,null,null,null,null,null,null,null,1161,761,1206,780,1197,697,1169,741,1137,337,1369,746,1450,840,1403,855,5536,3366,1627,766,null,null,null,null,null,null,null,null,null,null,null,null,1042,305,1039,358,1094,202,1106,239,1045,213,1252,202,1321,239,1321,877,5099,1446,1470,570,null,null,null,null,null,null,null,null,null,null,null,null,1001,219,1002,227,1022,238,1016,263,1018,228,1249,235,1258,237,1212,241,4852,1015,1356,216,null,null,null,null,null,null,null,null,null,null,null,null,1549,238,1561,246,1544,273,1534,247,1584,256,1844,239,1746,248,1820,225,7054,980,1970,252,null,null,null,null,null,null,null,null,null,null,null,null,447,686,465,656,469,631,429,723,474,698,688,733,694,676,740,735,2679,2790,832,674],[5433,112,4814,81,5603,89,5749,141,5560,66,1922,67,1481,71,1450,82,5665,258,1441,79,null,null,null,null,null,null,null,null,null,null,null,null,5463,259,5486,143,5452,155,5423,300,5447,166,1517,175,1450,149,1838,246,6167,625,1530,147,null,null,null,null,null,null,null,null,null,null,null,null,5276,256,5251,176,5191,175,5184,158,5410,180,1427,152,1455,154,1931,149,10863,665,1530,187,null,null,null,null,null,null,null,null,null,null,null,null,5147,181,5195,197,4986,601,5078,228,5074,190,5071,205,5229,256,3827,216,22972,690,1517,175,null,null,null,null,null,null,null,null,null,null,null,null,4901,182,5017,165,4939,211,4924,192,4770,176,5416,183,5446,206,5831,193,22874,793,1591,196,null,null,null,null,null,null,null,null,null,null,null,null,4621,230,4778,263,4618,281,4673,291,4658,686,5403,359,5539,213,5877,203,21507,827,6006,232,null,null,null,null,null,null,null,null,null,null,null,null,4292,846,4448,747,4247,869,4494,864,4229,888,5292,873,5006,906,5356,253,20294,3082,5906,580,null,null,null,null,null,null,null,null,null,null,null,null,3947,924,4034,995,4044,918,4105,978,4117,934,4890,956,4954,976,4889,983,19370,3978,5655,963,null,null,null,null,null,null,null,null,null,null,null,null,6318,965,6392,924,6477,952,6272,1010,6363,1027,7240,988,7297,1047,7162,1029,28241,4017,7739,962,null,null,null,null,null,null,null,null,null,null,null,null,1798,2764,1786,2800,1772,2752,1762,2845,1738,2896,2654,2912,2735,2814,2781,2892,10223,11255,3249,2740]]}
</textarea>

  <div id="chart"></div>
</html>
