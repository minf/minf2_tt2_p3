<html>
  <head>
    <title>Reinforcement Blackjack</title>

    <script type="text/javascript" src="jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="tooltip.js"></script>
    <script type="text/javascript" src="cardstack.js"></script>
    <script type="text/javascript" src="blackjack.js"></script>
    <script type="text/javascript" src="player.js"></script>
    <script type="text/javascript" src="dealer.js"></script>
    <script type="text/javascript" src="game.js"></script>
    <script type="text/javascript" src="human_player.js"></script>
    <script type="text/javascript" src="montecarlo_player.js"></script>
    <script type="text/javascript" src="highcharts/highcharts.js"></script>

    <link rel="stylesheet" href="blackjack.css" />
  </head>

  <body>
    <div id="page">
      <div id="dealer" class="player">
      </div>

      <div id="stack">
        <img src="images/card-stack.png" />
      </div>

      <div id="players">
      </div>
    </div>
  </body>

  <script type="text/javascript">
    $(document).ready(
      function() {
        var game = new Game();

        game.match();

        $("[title]").live("mouseover", function() {
          $(this).tooltip($(this).attr("title"));
        });

        $(".player").live("mouseout", function() {
          $.hideTooltips();
        });

        $("#stack").live("mouseover", function() {
          $(this).tooltip("Der Kartenstapel hat noch " + game.getCardstack().size() + " Karten");
        });

        $("#stack").live("mouseout", function() {
          $.hideTooltips();
        });

        $(".player").live("mouseover", function() {
          $(this).css("border-color", "#fff");
        });

        $(".player").live("mouseout", function() {
          $(this).css("border-color", "#888");
        });

        var dealerHand = 2;

   			$(window).keydown(
				  function(e) {
            if(e.keyCode == 27) { // 'esc' key: hide dump
              game.unpause();

              $("textarea").hide();

              $("#chart").hide();
            }

            if(e.keyCode == 68) { // 'd' key: dump monte carlo player
              game.pause();

              var dump = $(".monte-carlo-player")[0].player.dump();

              $("textarea")
                .show()
                .css("left", 50)
                .css("top", 50)
                .css("width", $(window).width() - 100)
                .css("height", $(window).height() - 100)
                .val(dump);
            }

            if(e.keyCode == 76) { // 'l' key: load copy/pasted dump into monte carlo player
              var dump = $("textarea").val();

              $(".monte-carlo-player")[0].player.load(dump);

              alert("loaded");
            }

            // draw chart of Q values

            function drawChart() {
              game.pause();

              $("#chart")
                .css("left", 50)
                .css("top", 50)
                .css("width", $(window).width() - 100)
                .css("height", $(window).height() - 100)
                .show();

              var dataHit = [];
              var dataStick = [];

              if(dealerHand<2){
                for(var p1 = 12; p1 <= 21; p1++){
                  for(var d1 = 2; d1 <= 11; d1++){
                    var mcPlayer = $(".monte-carlo-player")[0].player;
                    var stateIndex = mcPlayer.stateIndexFor(p1, d1, dealerHand);

                    if(mcPlayer.pi[stateIndex])
                      dataHit.push([p1,d1]);
                    else
                      dataStick.push([p1,d1]);
                  }
                }
              }
              else{
                for(var p1 = 12; p1 <= 21; p1++) {
                  var mcPlayer = $(".monte-carlo-player")[0].player;

                  dataHit.push(mcPlayer.Q[0][mcPlayer.stateIndexFor(p1, dealerHand, 0)]);
                  dataStick.push(mcPlayer.Q[1][mcPlayer.stateIndexFor(p1, dealerHand, 0)]);
                }
              }

              new Highcharts.Chart({
                chart: {
                  renderTo: "chart",
                  defaultSeriesType: dealerHand<2?"scatter":"line",
                  marginRight: 130,
                  marginBottom: 25
                },
                title: {
                  text: dealerHand==1?"Monte Carlo ES, usable ace":
                        (dealerHand==0?"Monte Carlo ES":"Monte Carlo ES Strategy (Dealer: " + dealerHand + ")"),
                  x: -20 //center
                },
                xAxis: {
                  categories: [ "12", "13", "14", "15", "16", "17", "18", "19", "20", "21" ]
                },
                yAxis: {
                  title: {
                    text: dealerHand<2?"Dealer showing":"Q"
                  },
                  plotLines: [{
                    value: 0,
                    width: 1,
                    color: "#808080"
                  }]
                },
                series: [{
                  name: dealerHand<2?"Hit":"Q(Hit)",
                  data: dataHit
                }, {
                  name: dealerHand<2?"Stick":"Q(Stick)",
                  data: dataStick
                }],
                plotOptions: {
                  scatter: {
                    marker: {
                      radius: 10
                    }
                  }
                }
              });
            }

            if(e.keyCode == 67) // 'c'
              drawChart();

            if(e.keyCode == 38) { // 'up'
              if(dealerHand < 11){
                dealerHand++;
                drawChart();
              }
            }

            if(e.keyCode == 40) { // 'down'
              if(dealerHand > 0){
                dealerHand--;
                drawChart();
              }
            }
          }
        );
      }
    );
  </script>

  <textarea></textarea>

  <div id="chart"></div>
</html>
